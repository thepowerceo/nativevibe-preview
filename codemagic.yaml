# Codemagic CI/CD configuration for NativeVibe Flutter apps
# Generated automatically - do not edit manually

workflows:
  default:
    name: NativeVibe Build
    labels:
      - native-vibe
    max_build_duration: 60
    instance_type: linux
    
    environment:
      flutter: 3.24.0
      xcode: latest
      cocoapods: default

    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
          source: true

    scripts:
      - name: Verify Flutter project structure
        script: |
          # Verify native folders exist (should be generated by NativeVibe)
          if [ ! -d "android" ] || [ ! -d "ios" ]; then
            echo "Warning: Native folders missing. This shouldn't happen - they should be included in the push."
            echo "Falling back to flutter create recovery..."
            
            # Save existing files
            mkdir -p /tmp/saved_files
            cp -r lib /tmp/saved_files/ 2>/dev/null || true
            cp pubspec.yaml /tmp/saved_files/ 2>/dev/null || true
            cp -r assets /tmp/saved_files/ 2>/dev/null || true
            
            # Get package name from pubspec
            PACKAGE_NAME=$(grep "^name:" pubspec.yaml | sed 's/name: *//')
            
            # Go to parent and recreate project
            cd ..
            rm -rf clone
            flutter create --org com.nativevibe "$PACKAGE_NAME"
            mv "$PACKAGE_NAME" clone
            cd clone
            
            # Restore saved files
            cp -r /tmp/saved_files/lib/* lib/ 2>/dev/null || true
            cp /tmp/saved_files/pubspec.yaml . 2>/dev/null || true
            cp -r /tmp/saved_files/assets . 2>/dev/null || true
          else
            echo "Native folders verified: android/ and ios/ present"
          fi
          
          # Ensure Kotlin version compatibility for Flutter 3.24+
          if [ -f "android/settings.gradle" ]; then
            if grep -q 'org.jetbrains.kotlin.android' android/settings.gradle; then
              echo "Verifying Kotlin version in settings.gradle..."
              sed -i 's/id "org.jetbrains.kotlin.android" version "[^"]*"/id "org.jetbrains.kotlin.android" version "1.9.24"/' android/settings.gradle
            fi
          fi
          
      - name: Get Flutter packages
        script: flutter pub get
        
      - name: Run analyzer
        script: flutter analyze --no-fatal-infos
        ignore_failure: true

      - name: Build Android APK
        script: flutter build apk --release

    artifacts:
      - build/app/outputs/flutter-apk/app-release.apk
