# Codemagic CI/CD configuration for NativeVibe Flutter apps
# Generated automatically - do not edit manually
# Optimized with aggressive caching for faster builds

workflows:
  default:
    name: NativeVibe Build
    labels:
      - native-vibe
    max_build_duration: 60
    instance_type: mac_mini_m1
    
    environment:
      flutter: 3.24.0
      xcode: 15.4
      cocoapods: default
      vars:
        # Enable Gradle build cache and parallel execution
        GRADLE_OPTS: "-Dorg.gradle.caching=true -Dorg.gradle.parallel=true -Dorg.gradle.daemon=true -Dorg.gradle.jvmargs=-Xmx4g"
        # Enable Flutter incremental builds
        FLUTTER_BUILD_MODE: "release"

    cache:
      cache_paths:
        # Flutter/Dart caches
        - $HOME/.pub-cache
        - $FCI_BUILD_DIR/.dart_tool
        - $FCI_BUILD_DIR/.packages
        
        # Android caches - comprehensive Gradle caching
        - $HOME/.gradle/caches
        - $HOME/.gradle/wrapper
        - $HOME/.android/build-cache
        - $FCI_BUILD_DIR/android/.gradle
        - $FCI_BUILD_DIR/build
        - $FCI_BUILD_DIR/android/app/build/intermediates
        - $FCI_BUILD_DIR/android/app/build/generated
        
        # iOS caches - CocoaPods and Xcode derived data
        - $HOME/Library/Caches/CocoaPods
        - $HOME/.cocoapods/repos
        - $FCI_BUILD_DIR/ios/Pods
        - $FCI_BUILD_DIR/ios/.symlinks
        - $FCI_BUILD_DIR/ios/Flutter/ephemeral
        - $HOME/Library/Developer/Xcode/DerivedData

    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
          source: true

    scripts:
      - name: Verify Flutter project structure
        script: |
          # Verify native folders exist (should be generated by NativeVibe)
          if [ ! -d "android" ] || [ ! -d "ios" ]; then
            echo "Warning: Native folders missing. This shouldn't happen - they should be included in the push."
            echo "Falling back to flutter create recovery..."
            
            # Save existing files
            mkdir -p /tmp/saved_files
            cp -r lib /tmp/saved_files/ 2>/dev/null || true
            cp pubspec.yaml /tmp/saved_files/ 2>/dev/null || true
            cp -r assets /tmp/saved_files/ 2>/dev/null || true
            
            # Get package name from pubspec
            PACKAGE_NAME=$(grep "^name:" pubspec.yaml | sed 's/name: *//')
            
            # Go to parent and recreate project
            cd ..
            rm -rf clone
            flutter create --org com.nativevibe "$PACKAGE_NAME"
            mv "$PACKAGE_NAME" clone
            cd clone
            
            # Restore saved files
            cp -r /tmp/saved_files/lib/* lib/ 2>/dev/null || true
            cp /tmp/saved_files/pubspec.yaml . 2>/dev/null || true
            cp -r /tmp/saved_files/assets . 2>/dev/null || true
          else
            echo "Native folders verified: android/ and ios/ present"
          fi
          
          # Ensure Kotlin version compatibility for Flutter 3.24+
          if [ -f "android/settings.gradle" ]; then
            if grep -q 'org.jetbrains.kotlin.android' android/settings.gradle; then
              echo "Verifying Kotlin version in settings.gradle..."
              sed -i 's/id "org.jetbrains.kotlin.android" version "[^"]*"/id "org.jetbrains.kotlin.android" version "1.9.24"/' android/settings.gradle
            fi
          fi

      - name: Configure Gradle for caching
        script: |
          # Enable Gradle build cache
          mkdir -p $HOME/.gradle
          cat > $HOME/.gradle/gradle.properties << EOF
          org.gradle.caching=true
          org.gradle.parallel=true
          org.gradle.daemon=true
          org.gradle.jvmargs=-Xmx4g -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          org.gradle.configureondemand=true
          android.enableBuildCache=true
          android.useAndroidX=true
          kotlin.incremental=true
          kotlin.incremental.java=true
          kotlin.caching.enabled=true
          EOF
          
          # Configure local build cache directory
          mkdir -p $HOME/.android/build-cache
          echo "Gradle build cache configured"
          
      - name: Get Flutter packages
        script: |
          echo "Fetching Flutter dependencies..."
          flutter pub get
          echo "Dependencies cached for future builds"
        
      - name: Run analyzer
        script: flutter analyze --no-fatal-infos
        ignore_failure: true

      - name: Pre-warm Android build cache
        script: |
          echo "Checking for cached build artifacts..."
          if [ -d "$HOME/.gradle/caches" ]; then
            echo "Gradle cache found - build should be faster"
            du -sh $HOME/.gradle/caches 2>/dev/null || true
          fi
          if [ -d "$HOME/.android/build-cache" ]; then
            echo "Android build cache found"
            du -sh $HOME/.android/build-cache 2>/dev/null || true
          fi

      - name: Build Android APK
        script: |
          echo "Building Android APK with caching enabled..."
          flutter build apk --release
          echo "Build complete - artifacts will be cached for next build"

      - name: Pre-warm iOS build cache
        script: |
          echo "Checking for cached CocoaPods..."
          if [ -d "$HOME/Library/Caches/CocoaPods" ]; then
            echo "CocoaPods cache found"
            du -sh $HOME/Library/Caches/CocoaPods 2>/dev/null || true
          fi
          if [ -d "$HOME/Library/Developer/Xcode/DerivedData" ]; then
            echo "Xcode DerivedData cache found"
            du -sh $HOME/Library/Developer/Xcode/DerivedData 2>/dev/null || true
          fi

      - name: Install CocoaPods dependencies
        script: |
          cd ios
          # Use cached pods if available
          if [ -f "Podfile.lock" ]; then
            echo "Podfile.lock found - checking for cached pods..."
            pod install --deployment || pod install || pod install --repo-update
          else
            echo "Fresh pod install..."
            pod install || pod install --repo-update
          fi
          echo "CocoaPods ready - dependencies cached for next build"
          
      - name: Build iOS (unsigned)
        script: |
          echo "Building iOS with caching enabled..."
          flutter build ios --release --no-codesign
          cd build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r ../../../ios-build-unsigned.ipa Payload
          echo "iOS build complete - derived data cached for next build"

    artifacts:
      - build/app/outputs/flutter-apk/app-release.apk
      - ios-build-unsigned.ipa
      - /tmp/xcodebuild_logs/*.log
