# Codemagic CI/CD configuration for NativeVibe Flutter apps
# Generated automatically - do not edit manually

workflows:
  default:
    name: NativeVibe Build
    labels:
      - native-vibe
    max_build_duration: 60
    instance_type: linux
    
    environment:
      flutter: 3.24.0
      xcode: latest
      cocoapods: default

    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
          source: true

    scripts:
      - name: Ensure Flutter project structure
        script: |
          # If android or ios folders are missing, recreate them with flutter create
          if [ ! -d "android" ] || [ ! -d "ios" ]; then
            echo "Native folders missing, regenerating with flutter create..."
            # Save existing files
            mkdir -p /tmp/saved_files
            cp -r lib /tmp/saved_files/ 2>/dev/null || true
            cp pubspec.yaml /tmp/saved_files/ 2>/dev/null || true
            cp -r assets /tmp/saved_files/ 2>/dev/null || true
            
            # Get package name from pubspec
            PACKAGE_NAME=$(grep "^name:" pubspec.yaml | sed 's/name: *//')
            
            # Go to parent and recreate project
            cd ..
            rm -rf clone
            flutter create --org com.nativevibe "$PACKAGE_NAME"
            mv "$PACKAGE_NAME" clone
            cd clone
            
            # Restore saved files
            cp -r /tmp/saved_files/lib/* lib/ 2>/dev/null || true
            cp /tmp/saved_files/pubspec.yaml . 2>/dev/null || true
            cp -r /tmp/saved_files/assets . 2>/dev/null || true
          fi
          
          # Fix Kotlin version compatibility for Flutter 3.24+
          if [ -f "android/settings.gradle" ]; then
            echo "Updating Kotlin version in settings.gradle..."
            sed -i 's/id "org.jetbrains.kotlin.android" version "[^"]*"/id "org.jetbrains.kotlin.android" version "1.9.24"/' android/settings.gradle
          fi
          if [ -f "android/build.gradle" ]; then
            echo "Updating Kotlin version in build.gradle..."
            sed -i "s/ext.kotlin_version = '[^']*'/ext.kotlin_version = '1.9.24'/" android/build.gradle
          fi
          
      - name: Get Flutter packages
        script: flutter pub get
        
      - name: Run analyzer
        script: flutter analyze --no-fatal-infos
        ignore_failure: true

      - name: Build Android APK
        script: flutter build apk --release

    artifacts:
      - build/app/outputs/flutter-apk/app-release.apk

